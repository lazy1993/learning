## 第七章 网络编程  

> Node 是一个面向网络而生的平台，它具有事件驱动、无阻塞、单线程等特性，具备良好的可伸缩性，使得它十分轻量，适合在分布式网络中扮演各种各样的角色。  

## 7.1 构建 TCP 服务  

* OSI模型由七层组成：物理层、数据链结层、网络层、传输层、会话层、表示层、应用层。  

* OSI 七层协议示意：  

        HTTP / SMTP / IMAP 等   ：  应用层  
        加密 / 解密 等           ：  表示层  
        通信连接 / 维持会话      ：  会话层  
        TCP / UDP               ：  传输层  
        IP                      ：  网络层  
        网络特有的链路接口        ：  链路层  
        网络物理硬件             ：  物理层  

* TCP 全名传输控制协议，在 OSI 模型中属于传输层协议。  

* TCP 是面向连接的协议，其显著的特征是在传输之前需要 3 次握手形成会话。  

* 只有在会话形成之后，服务器端和客户端之间才能互相发送数据。  

* TCP 针对网络中的小数据包有一定的优化策略：Nagle 算法。  

* Nagle 算法要求缓冲区的数据达到一定数量或者一定时间后才将其发出，所以小数据包会被 Nagel 算法合并，以此来优化网络。  

* Nagle 算法优化虽然使网络带宽呗有效地使用，但是数据有可能被延迟发送。  

* 在 Node 中，由于 TCP 默认开启了 Nagle 算法，可以调用 socket.setNoDelay(true) 去掉 Nagle 算法。  

* UDP 又称用户数据包协议，与 TCP 一样同属网络传输层。  

* UDP 与 TCP 最大的不同是 UDP 不是面向连接的。  

* UDP 提供面向事务的简单不可靠信息传输服务，无需连接，资源消耗低，处理快速且灵活。  

* UDP 常应用在那种偶尔丢一两个数据包也不会产生重大影响的场景，比如音频、视频等。  

### 7.3 构建 HTTP 服务   

* TCP 与 UDP 都属于网络传输层协议，如果要构造高效的网络应用，就应该从传输层进行着手。  

* 对于经典的应用场景，则无须从传输层协议入手构造自己的应用，比如 HTTP 或 SMTP 等，这些经典的应用层协议对于普通应用而言绰绰有余。  

* HTTP 的全称是**超文本传输协议**，英文写作 **HyperText Transfer Protoclo** 。  

* HTTP 构建在 TCP 之上，属于应用层协议。在 HTTP 的两端是服务器和浏览器，即著名的 B/S 模式，如今精彩纷呈的 Web 即是 HTTP 的应用。  

* HTTP 的特点是：基于请求响应式的，以一问一答的方式实现服务，虽然基于 TCP 会话，但是本身确并无会话的特点。  

* 在 Node 中，HTTP 服务继承自 TCP 服务器（net 模块），它能够与多个客户端保持连接，由于其采用事件驱动的形式，并不为每一个连接创建额外的线程或进程，保持很低的内存占用，所以能实现高并发。  

* HTTP 服务与 TCP 服务模型有区别的地方在于，在开启 keepalive 后，一个 TCP 会话可以用于多次请求和响应。  

* TCP 服务以 connnection 为单位进行服务，HTTP 服务以 request 为单位进行服务。  

* 为了重用 TCP 连接，http 模块包含一个默认的客户端代理对象 http.globalAgent。它对每个服务器端（host + port）创建的连接进行了管理，默认情况下，通过 clientRequest 对象对同一个服务端发起的 HTTP 请求最多可以创建 5 个连接。  

### 7.4 构建 WebSocket 服务  

* WebSocket 协议与 Node 之间配合堪称完美：  
  * WebSocket 客户端基于事件的变成模型与 Node 中自定义事件相差无几。  
  * WebSocket 实现了客户端与服务器端之间的长连接，而 Node 事件驱动的方式十分擅长与大量的客户端保持高并发连接。  

* WebSocket 与传统 HTTP 有如下好处：  
  * 客户端与服务端只建立一个 TCP 连接，可以使用更少的连接。  
  * WebSocket 服务器端可以推送数据到客户端，这远比 HTTP 请求响应模式更灵活、更高效。  
  * 有更轻量的协议头，减少数据传送量。  

* 在 WebSocket 之前，网页客户端与服务端进行通信最高效的是 **Comet** 技术。  

* Comet 技术的实现细节是采用长轮询（long-polling）或 iframe 流。  

* 长轮询的原理是：客户端向服务端发起请求，服务端只在超时或有数据响应时断开连接（res.end()），客户端在收到数据或者超时后重新发起请求。这个请求行为拖着长长的尾巴，是故用 Comet（彗星）来命名它。  

* WebSocket 协议主要分为两个部分：握手和数据传输。  

* WebSocket 没有在 HTTP 的基础上模拟服务器的推送，而是在 TCP 上定义独立的协议。但是 WebSocket 的握手部分是由 HTTP 完成的。  



